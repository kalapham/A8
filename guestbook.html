<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lưu bút - Lớp A8</title>
  <link rel="icon" href="images/logo-a8.png" type="image/png" />
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCyqMBaXEDcZ32aWZJyAt8DCg94SpzjdLc",
      authDomain: "lopa8-f84f8.firebaseapp.com",
      projectId: "lopa8-f84f8",
      storageBucket: "lopa8-f84f8.firebasestorage.app",
      messagingSenderId: "955064222486",
      appId: "1:955064222486:web:b8e57aadabb338082d8637",
      measurementId: "G-436QXV62VQ"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    async function loadNotes() {
      const container = document.getElementById("notes-container");
      container.innerHTML = "<p>Đang tải lưu bút...</p>";
      try {
        const querySnapshot = await getDocs(collection(db, "guestbook"));
        const notes = [];
        querySnapshot.forEach((doc) => {
          const data = doc.data();
          notes.push({
            name: data.name,
            message: data.message,
            timestamp: data.timestamp ? data.timestamp.toDate() : null
          });
        });

        notes.sort((a, b) => {
          if (!a.timestamp) return 1;
          if (!b.timestamp) return -1;
          return b.timestamp - a.timestamp;
        });

        container.innerHTML = "";
        if (notes.length === 0) {
          container.innerHTML = "<p>Chưa có lưu bút nào.</p>";
          return;
        }

        for (const note of notes) {
          const noteDiv = document.createElement("div");
          noteDiv.className = "note";
          const timeHTML = note.timestamp ? `<small>${note.timestamp.toLocaleString('vi-VN')}</small>` : "";
          noteDiv.innerHTML = `<h4>${note.name}</h4>${timeHTML}<p>${note.message}</p>`;
          container.appendChild(noteDiv);
        }
      } catch (err) {
        container.innerHTML = `<p style="color:red;">Không thể tải lưu bút: ${err.message}</p>`;
        console.error("Lỗi khi tải lưu bút:", err);
      }
    }

    async function submitNote(event) {
      event.preventDefault();
      const name = document.getElementById("name").value.trim();
      const message = document.getElementById("message").value.trim();
      if (!name || !message) return;

      try {
        await addDoc(collection(db, "guestbook"), {
          name: name,
          message: message,
          timestamp: serverTimestamp()
        });
        document.getElementById("name").value = "";
        document.getElementById("message").value = "";
        loadNotes();
      } catch (err) {
        alert("Không thể gửi lưu bút: " + err.message);
        console.error("Lỗi gửi lưu bút:", err);
      }
    }

    function toggleMode() {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", document.body.classList.contains("dark"));
    }

    window.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark");
      }
      loadNotes();
    });

    window.submitNote = submitNote;
    window.toggleMode = toggleMode;
  </script>
  <style>
    /* styles giữ nguyên như bạn đã đưa, bao gồm header, nav, darkmode, form... */
  </style>
</head>
<body>
  <header>
    <h1>Lớp A8 – Niên khóa 2021–2025</h1>
    <p>Lưu bút – Nơi chia sẻ những kỷ niệm</p>
    <button class="toggle-mode" onclick="toggleMode()" aria-label="Chuyển chế độ sáng/tối">
      <svg viewBox="0 0 24 24">
        <path d="M12 2a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0V3a1 1 0 0 1 1-1zm6.364 3.636a1 1 0 0 1 1.414 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707zM21 11a1 1 0 1 1 0 2h-1a1 1 0 1 1 0-2h1zm-2.222 6.364a1 1 0 0 1 0 1.414l-.707.707a1 1 0 1 1-1.414-1.414l.707-.707a1 1 0 0 1 1.414 0zM12 19a1 1 0 0 1 1 1v1a1 1 0 1 1-2 0v-1a1 1 0 0 1 1-1zm-6.364-1.636a1 1 0 0 1 1.414 0l.707.707a1 1 0 1 1-1.414 1.414l-.707-.707a1 1 0 0 1 0-1.414zM4 11a1 1 0 1 1 0 2H3a1 1 0 1 1 0-2h1zm2.222-6.364a1 1 0 0 1 0 1.414l-.707.707A1 1 0 0 1 4.1 5.05l.707-.707a1 1 0 0 1 1.414 0zM12 6a6 6 0 1 0 0 12A6 6 0 0 0 12 6z"/>
      </svg>
    </button>
    <nav>
      <ul>
        <li><a href="index.html">Trang chủ</a></li>
        <li><a href="gallery.html">Album ảnh</a></li>
        <li><a href="guestbook.html" class="active">Lưu bút</a></li>
        <li><a href="classlist.html">Danh sách lớp</a></li>
        <li><a href="events.html">Thông tin</a></li>
        <li><a href="documents.html">Tài liệu</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <section class="section">
      <h2>Những dòng lưu bút</h2>
      <div id="notes-container"></div>

      <h3>Gửi lưu bút của bạn</h3>
      <form onsubmit="submitNote(event)">
        <input type="text" id="name" placeholder="Tên của bạn" required />
        <textarea id="message" rows="4" placeholder="Lời nhắn..." required></textarea>
        <button type="submit">Gửi</button>
      </form>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 Lớp A8 - Thiết kế bởi chúng ta</p>
  </footer>
</body>
</html>
